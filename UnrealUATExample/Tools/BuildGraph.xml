<?xml version='1.0' ?>
<!--
For more information on build graph go to https://dev.epicgames.com/documentation/en-us/unreal-engine/buildgraph-script-anatomy-for-unreal-engine
To run this build graph run [path to RunUAT script] -Script=[path to this file] -Target="[Name of the node you want to run]"

To pass parameter values for TargetProject and stuff use something like
./RunUAT.bat BuildGraph -Script=MyBuildGraph.xml -Target=MyProject -Set:MyBooleanOption=true -Set:MyStringValue="Hello World"
-->

<!--
Known issues:
    Right now this script is very monolitic. Everything will stay in disk until the process finishes. 
    There is still enough modularity to run any node and only needs its dependencies 
    but I (Daniel) would like to understand agents more and be able to break down the script more modularily.
-->
<BuildGraph xmlns="http://www.epicgames.com/BuildGraph"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.epicgames.com/BuildGraph ../../../Engine/Build/Graph/Schema.xsd">

    <Option Name="TargetProject" Restrict="[^ ]*" DefaultValue="" Description="The target project path"/>
    <Option Name="TargetName" Restrict="[^ ]*" DefaultValue="" Description="The target project name"/>
    <Option Name="BuildType" Restrict="Development|Debug|Shipping" DefaultValue="Development" Description= "Type of editor to compile" />
    <Option Name="TestNames" DefaultValue="Lute.+M_" Description="Test to run"/>
    <Option Name="UnrealCMDPath" DefaultValue="C:\Program Files\Epic Games\UE_5.6\Engine\Binaries\Win64\UnrealEditor-Cmd.exe" Description="Path to the UnrealEditor-Cmd.exe (or variant) to use"/>
    <Option Name="ReportPath" DefaultValue="D:\reports" Description="Where to dump the test reports" />
    <Option Name="ReportFormats" DefaultValue="xml+json" Description="What format to output the reports in"/>
    <Option Name="ShippingOutputPath" DefaultValue="D:\shipping" Description="Where to output the finished shipping build" />

    <Agent Name="Default Agent" Type="Win64">
        <Node Name="Compile UnrealEditor Win64" Produces="#EditorBinaries">
            <Compile Target="$(TargetName)Editor" Platform="Win64" 
            Configuration="$(BuildType)" Project="$(TargetProject)" Tag="#EditorBinaries" Arguments="-NullRHI"/>
        </Node>

        <Node Name="Run All Tests" Requires="#EditorBinaries">
            <Spawn Exe="$(UnrealCMDPath)" Arguments="$(TargetProject) -unattended -nopause -nosplash -NullRHI -ExecCmds='Automation RunTest $(TestNames);Quit' -ReportExportPath='$(ReportPath)' -ReportOutputFormats=$(ReportFormats) -TestExit='Automation Test Queue Empty' -Log -Verbose -Log=$(ReportPath)/Spec/RunLog.log"  LogOutput="true"/>
        </Node>
     
        <Node Name="Start Shipping Build" Requires="Run All Tests">
            <Command Name="Turnkey" Arguments="-ScriptsForProject=$(TargetProject) -command=VerifySdk -platform=Win64 -UpdateIfNeeded -EditorIO -EditorIOPort=63119  -project=$(TargetProject)"/>
        </Node>
        
        <Node Name="Make Shipping Build" Requires="Start Shipping Build">
            <Command Name="BuildCookRun" Arguments="-nop4 -utf8output -nocompileeditor -skipbuildeditor -cook -project=$(TargetProject) -target=$(TargetName) -unrealexe='$(UnrealCMDPath)' -platform=Win64 -installed -stage -archive -package -build -pak -iostore -compressed -prereqs -archivedirectory=$(ShippingOutputPath) -clientconfig=Shipping -nodebuginfo "/>
            <!-- Here The target type is not parametrized because these nodes are specific for shipping targets -->
        </Node>
    </Agent>
</BuildGraph>

<!--
Start Build
 -ScriptsForProject="C:/Users/oroz0020/Downloads/RPGParty/RPGParty.uproject" Turnkey -command=VerifySdk -platform=Win64 -UpdateIfNeeded -EditorIO -EditorIOPort=63119  -project="C:/Users/oroz0020/Downloads/RPGParty/RPGParty.uproject"


Make Build
   BuildCookRun -nop4 -utf8output -nocompileeditor -skipbuildeditor -cook -project='C:/Users/oroz0020/Downloads/RPGParty/RPGParty.uproject' -target=RPGParty -unrealexe='C:\Program Files\Epic Games\UE_5.6\Engine\Binaries\Win64\UnrealEdito
r-Win64-DebugGame-Cmd.exe' -platform=Win64 -installed -stage -archive -package -build -pak -iostore -compressed -prereqs -archivedirectory='C:/Users/oroz0020/Downloads/Release/Graph' -clientconfig=Shipping -nodebuginfo


Unused yet
      -nocompile -nocompileuat
-->
